import { BattleSystem } from '../systems/battle/BattleSystem.js';
import { TravelSystem } from '../systems/world/TravelSystem.js';
import { WorldMap } from '../systems/world/WorldMap.js';
import { GatheringSystem } from '../systems/gathering/GatheringSystem.js';
import { CraftingSystem } from '../systems/crafting/CraftingSystem.js';
import { ProfileSystem } from '../systems/profile/ProfileSystem.js';
import { RegistrationSystem } from '../systems/registration/RegistrationSystem.js';
import { AutoResponseSystem } from '../systems/autoResponse/AutoResponseSystem.js';
import Player from './Player.js';
import { ProfileCardGenerator } from '../utils/ProfileCardGenerator.js'; 

export default class CommandHandler {
    constructor() {
        console.log('ğŸ”„ ØªÙ‡ÙŠØ¦Ø© CommandHandler...');

        try {
            this.battleSystem = new BattleSystem();
            this.travelSystem = new TravelSystem();
            this.worldMap = new WorldMap(this.travelSystem);
            this.gatheringSystem = new GatheringSystem();
            this.craftingSystem = new CraftingSystem();
            this.profileSystem = new ProfileSystem();
            this.registrationSystem = new RegistrationSystem();
            this.autoResponseSystem = new AutoResponseSystem();
            this.cardGenerator = new ProfileCardGenerator(); 

            // ğŸ†• Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            this.commands = {
                'Ø¨Ø¯Ø¡': this.handleStart.bind(this),
                'Ù…Ø¹Ø±ÙÙŠ': this.handleGetId.bind(this),
                'Ø°ÙƒØ±': this.handleGenderMale.bind(this),
                'Ø£Ù†Ø«Ù‰': this.handleGenderFemale.bind(this),
                'Ø§Ø³Ù…ÙŠ': this.handleSetName.bind(this),
                'Ù…Ø¯ÙŠØ±': this.handleAdminCommands.bind(this),
                'Ù…ÙˆØ§ÙÙ‚Ø©_Ù„Ø§Ø¹Ø¨': this.handleApprovePlayer.bind(this),
                'Ø§Ø¶Ù_Ø±Ø¯': this.handleAddResponse.bind(this),
                'Ø§Ø²Ù„_Ø±Ø¯': this.handleRemoveResponse.bind(this),
                'Ø¹Ø±Ø¶_Ø§Ù„Ø±Ø¯ÙˆØ¯': this.handleShowResponses.bind(this),
                'Ø­Ø§Ù„ØªÙŠ': this.handleStatus.bind(this),
                'Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ': this.handleProfile.bind(this),
                'Ù…Ø³Ø§Ø¹Ø¯Ø©': this.handleHelp.bind(this),
                'Ø­Ù‚ÙŠØ¨ØªÙŠ': this.handleInventory.bind(this),
                'Ø®Ø±ÙŠØ·Ø©': this.handleMap.bind(this),
                'ØªØ¬Ù…ÙŠØ¹': this.handleGather.bind(this),
                'Ù…ØºØ§Ù…Ø±Ø©': this.handleAdventure.bind(this),
                'Ù‡Ø¬ÙˆÙ…': this.handleAttack.bind(this),
                'Ù‡Ø±ÙˆØ¨': this.handleEscape.bind(this),
                'ØªØºÙŠÙŠØ±_Ø§Ø³Ù…': this.handleChangeName.bind(this)
            };

            this.allowedBeforeApproval = ['Ø¨Ø¯Ø¡', 'Ù…Ø¹Ø±ÙÙŠ', 'Ù…Ø³Ø§Ø¹Ø¯Ø©', 'Ø°ÙƒØ±', 'Ø£Ù†Ø«Ù‰', 'Ø§Ø³Ù…ÙŠ'];
            
            console.log('âœ… CommandHandler ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© CommandHandler:', error);
            throw error;
        }
    }

    async process(sender, message) {
        const { id, name } = sender;
        const parts = message.trim().split(/\s+/);
        const command = parts[0].toLowerCase();
        const args = parts.slice(1);

        console.log(`ğŸ“¨ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø±: "${command}" Ù…Ù† ${name} (${id})`);

        // ğŸ†• Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        const autoResponse = this.autoResponseSystem.findAutoResponse(message);
        if (autoResponse) {
            console.log(`ğŸ¤– Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰: "${message}"`);
            return autoResponse;
        }

        try {
            let player = await Player.findOne({ userId: id });

            if (!player) {
                player = await Player.createNew(id, name);
            }

            if (player.banned) {
                return 'âŒ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø±.';
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            if (!this.allowedBeforeApproval.includes(command) && !player.isApproved()) {
                if (player.isPending()) {
                    return `â³ **Ø­Ø³Ø§Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©**

ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ù…Ø± "Ù…Ø¹Ø±ÙÙŠ" Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±ÙÙƒ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.`;
                } else if (player.isApprovedButNotCompleted()) {
                    const step = this.registrationSystem.getRegistrationStep(id);
                    if (step && step.step === 'gender_selection') {
                        return `ğŸ‘‹ **Ù…Ø±Ø­Ø¨Ø§Ù‹ ${player.name}!**

Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù†Ø³Ùƒ:
â€¢ Ø§ÙƒØªØ¨ "Ø°ÙƒØ±" ğŸ‘¦
â€¢ Ø§ÙƒØªØ¨ "Ø£Ù†Ø«Ù‰" ğŸ‘§`;
                    } else if (step && step.step === 'name_selection') {
                        return `ğŸ“ **Ø§Ù„Ø¢Ù† ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ**

Ø§ÙƒØªØ¨ "Ø§Ø³Ù…ÙŠ [Ø§Ù„Ø§Ø³Ù…]" Ø¨ÙŠÙ† 3 Ø¥Ù„Ù‰ 9 Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
Ù…Ø«Ø§Ù„: Ø§Ø³Ù…ÙŠ John`;
                    }
                }
            }

            if (this.commands[command]) {
                const result = await this.commands[command](player, args, id);
                
                if (typeof result === 'string') {
                    await player.save();
                }

                return result;
            } else {
                return await this.handleUnknown(command, player);
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù…Ø±:', error);
            return `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ: ${error.message}`;
        }
    }

    // ğŸ†• Ø£Ù…Ø± Ø¹Ø±Ø¶ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯ÙŠØ±
    async handleAdminCommands(player, args, senderId) {
        try {
            const ADMIN_PSID = process.env.ADMIN_PSID;
            
            if (senderId !== ADMIN_PSID) {
                return 'âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.';
            }

            return `ğŸ‘‘ **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯ÙŠØ± - Ù…ØºØ§Ø±Ø© ØºÙˆÙ„Ø¯**

ğŸ”„ **Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:**
â€¢ Ù…ÙˆØ§ÙÙ‚Ø©_Ù„Ø§Ø¹Ø¨ - Ø¹Ø±Ø¶/Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ†
â€¢ Ù…ÙˆØ§ÙÙ‚Ø©_Ù„Ø§Ø¹Ø¨ [Ø§Ù„Ù…Ø¹Ø±Ù] - Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù„Ø§Ø¹Ø¨ Ù…Ø­Ø¯Ø¯
â€¢ ØªØºÙŠÙŠØ±_Ø§Ø³Ù… [Ø§Ù„Ø§Ø³Ù…] - ØªØºÙŠÙŠØ± Ø§Ø³Ù…Ùƒ
â€¢ ØªØºÙŠÙŠØ±_Ø§Ø³Ù… [Ø§Ù„Ù…Ø¹Ø±Ù] [Ø§Ù„Ø§Ø³Ù…] - ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±

ğŸ¤– **Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:**
â€¢ Ø§Ø¶Ù_Ø±Ø¯ [Ø§Ù„Ù…ÙØªØ§Ø­] [Ø§Ù„Ø±Ø¯] - Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ
â€¢ Ø§Ø²Ù„_Ø±Ø¯ [Ø§Ù„Ù…ÙØªØ§Ø­] - Ø¥Ø²Ø§Ù„Ø© Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ  
â€¢ Ø¹Ø±Ø¶_Ø§Ù„Ø±Ø¯ÙˆØ¯ - Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯

ğŸ“Š **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:**
â€¢ Ù…Ø¯ÙŠØ± - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

ğŸ’¡ **Ù…Ø«Ø§Ù„:**
Ø§Ø¶Ù_Ø±Ø¯ Ø´ÙƒØ±Ø§Ù‹ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! Ø£Ø³Ø¹Ø¯Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ğŸ˜Š`;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ handleAdminCommands:', error);
            return 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯ÙŠØ±.';
        }
    }

    // ğŸ†• Ø£Ù…Ø± Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    async handleAddResponse(player, args, senderId) {
        try {
            const ADMIN_PSID = process.env.ADMIN_PSID;
            
            if (senderId !== ADMIN_PSID) {
                return 'âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.';
            }

            if (args.length < 2) {
                return 'âŒ ØµÙŠØºØ© Ø§Ù„Ø£Ù…Ø±: Ø§Ø¶Ù_Ø±Ø¯ [Ø§Ù„Ù…ÙØªØ§Ø­] [Ø§Ù„Ø±Ø¯]\nÙ…Ø«Ø§Ù„: Ø§Ø¶Ù_Ø±Ø¯ Ø´ÙƒØ±Ø§Ù‹ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! ğŸ˜Š';
            }

            const trigger = args[0];
            const response = args.slice(1).join(' ');

            this.autoResponseSystem.addResponse(trigger, response);

            return `âœ… **ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­!**

ğŸ”‘ Ø§Ù„Ù…ÙØªØ§Ø­: ${trigger}
ğŸ’¬ Ø§Ù„Ø±Ø¯: ${response}

Ø³ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø§Ù„Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒØªØ¨ Ø£ÙŠ Ù„Ø§Ø¹Ø¨: "${trigger}"`;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ handleAddResponse:', error);
            return 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.';
        }
    }

    // ğŸ†• Ø£Ù…Ø± Ø¥Ø²Ø§Ù„Ø© Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    async handleRemoveResponse(player, args, senderId) {
        try {
            const ADMIN_PSID = process.env.ADMIN_PSID;
            
            if (senderId !== ADMIN_PSID) {
                return 'âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.';
            }

            if (args.length === 0) {
                return 'âŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø²Ø§Ù„ØªÙ‡.\nÙ…Ø«Ø§Ù„: Ø§Ø²Ù„_Ø±Ø¯ Ø´ÙƒØ±Ø§Ù‹';
            }

            const trigger = args[0];
            const success = this.autoResponseSystem.removeResponse(trigger);

            if (success) {
                return `âœ… **ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­!**

ğŸ”‘ Ø§Ù„Ù…ÙØªØ§Ø­: ${trigger}
âŒ Ù„Ù… ÙŠØ¹Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.`;
            } else {
                return `âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙØªØ§Ø­: ${trigger}`;
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ handleRemoveResponse:', error);
            return 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.';
        }
    }

    // ğŸ†• Ø£Ù…Ø± Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    async handleShowResponses(player, args, senderId) {
        try {
            const ADMIN_PSID = process.env.ADMIN_PSID;
            
            if (senderId !== ADMIN_PSID) {
                return 'âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.';
            }

            const responses = this.autoResponseSystem.getAllResponses();
            const responseKeys = Object.keys(responses);

            if (responseKeys.length === 0) {
                return 'ğŸ¤– **Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.**';
            }

            let message = 'ğŸ¤– **Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:**\n\n';
            
            responseKeys.forEach((key, index) => {
                const response = responses[key];
                const preview = response.length > 50 ? response.substring(0, 50) + '...' : response;
                message += `${index + 1}. ğŸ”‘ **${key}**\n   ğŸ’¬ ${preview}\n\n`;
            });

            message += `ğŸ“Š **Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:** ${responseKeys.length} Ø±Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ`;

            return message;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ handleShowResponses:', error);
            return 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©.';
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø£Ù…Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    async handleHelp(player, args, senderId) {
        try {
            const ADMIN_PSID = process.env.ADMIN_PSID;
            const isAdmin = senderId === ADMIN_PSID;
            
            let helpMessage = `ğŸ†˜ **Ø£ÙˆØ§Ù…Ø± Ù…ØºØ§Ø±Ø© ØºÙˆÙ„Ø¯**

ğŸ¯ **Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:**
Ø¨Ø¯Ø¡ - Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£Ùˆ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
Ù…Ø¹Ø±ÙÙŠ - Ø¹Ø±Ø¶ Ù…Ø¹Ø±ÙÙƒ Ù„Ù„Ù…Ø¯ÙŠØ±
Ù…Ø³Ø§Ø¹Ø¯Ø© - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©`;

            if (player.isApproved()) {
                helpMessage += `

ğŸ—ºï¸ **Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù:**
Ø®Ø±ÙŠØ·Ø© - Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
ØªØ¬Ù…ÙŠØ¹ - Ø¬Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
Ù…ØºØ§Ù…Ø±Ø© - Ø¨Ø¯Ø¡ Ù…ØºØ§Ù…Ø±Ø©

ğŸ’ **Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:**
Ø­Ø§Ù„ØªÙŠ - Ø¹Ø±Ø¶ Ø­Ø§Ù„ØªÙƒ
Ø¨Ø±ÙˆÙØ§ÙŠÙ„ÙŠ - Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
Ø­Ù‚ÙŠØ¨ØªÙŠ - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª

âš”ï¸ **Ø§Ù„Ù‚ØªØ§Ù„:**
Ù‡Ø¬ÙˆÙ… - Ø§Ù„Ù‡Ø¬ÙˆÙ… ÙÙŠ Ø§Ù„Ù…Ø¹Ø±ÙƒØ©
Ù‡Ø±ÙˆØ¨ - Ø§Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±ÙƒØ©`;
            }

            if (isAdmin) {
                helpMessage += `

ğŸ‘‘ **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯ÙŠØ±:**
Ù…Ø¯ÙŠØ± - Ø¹Ø±Ø¶ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„Ø©`;
            }

            return helpMessage;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ handleHelp:', error);
            throw error;
        }
    }

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± (handleStart, handleGetId, etc.)
    // ... [Ù†ÙØ³ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±]
    
    async handleApprovePlayer(player, args, senderId) {
        try {
            const ADMIN_PSID = process.env.ADMIN_PSID;
            
            if (senderId !== ADMIN_PSID) {
                return 'âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.';
            }

            if (args.length === 0) {
                const pendingPlayers = await this.registrationSystem.getPendingPlayers();
                if (pendingPlayers.length === 0) {
                    return 'âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.';
                }

                let message = 'â³ **Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ† Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©:**\n\n';
                pendingPlayers.forEach((p, index) => {
                    message += `${index + 1}. ${p.name} - \`${p.userId}\` - ${new Date(p.createdAt).toLocaleDateString('ar-SA')}\n`;
                });
                
                message += '\nÙ„Ù„Ù…ÙˆØ§ÙÙ‚Ø©ØŒ Ø§ÙƒØªØ¨: Ù…ÙˆØ§ÙÙ‚Ø©_Ù„Ø§Ø¹Ø¨ [Ø§Ù„Ù…Ø¹Ø±Ù]';
                return message;
            }

            const targetUserId = args[0];
            return await this.registrationSystem.approvePlayer(targetUserId, senderId);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ handleApprovePlayer:', error);
            return 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø§Ø¹Ø¨.';
        }
    }

    async handleChangeName(player, args, senderId) {
        try {
            const ADMIN_PSID = process.env.ADMIN_PSID;
            
            if (senderId !== ADMIN_PSID) {
                return 'âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±.';
            }

            const result = await this.profileSystem.changeName(player, args, senderId);
            await player.save();
            
            if (typeof result === 'string' && result.includes('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨')) {
                return this.handleProfile(player);
            }
            
            return result;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ handleChangeName:', error);
            return 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù….';
        }
    }

    async handleUnknown(command, player) {
        return `â“ **Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ**: "${command}"\n\nØ§ÙƒØªØ¨ "Ù…Ø³Ø§Ø¹Ø¯Ø©" Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©.`;
    }
              }
